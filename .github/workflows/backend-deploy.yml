name: Deploy Backend to Azure (Container)

on:
  push:
    branches: [ ci/azure-deploy ]
    paths: 
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_BACKEND_NAME }}
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  IMAGE_NAME: workreserve-backend
  JAVA_VERSION: '21'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.extract_tag.outputs.deploy_tag }}
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build application
      working-directory: ./backend
      run: |
        echo "ğŸ—ï¸ Building Spring Boot application..."
        # Fix Maven wrapper permissions
        chmod +x ./mvnw
        ./mvnw clean package -DskipTests -B
        
        if [ ! -f target/*.jar ]; then
          echo "âŒ JAR file not found in target directory"
          exit 1
        fi
        
        echo "âœ… JAR file created successfully"
        ls -la target/*.jar

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=sha,prefix=ci-azure-deploy-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Extract specific deployment tag
      id: extract_tag
      run: |
        # Extract the SHA-based tag that was just built
        FULL_TAGS="${{ steps.meta.outputs.tags }}"
        echo "All tags: $FULL_TAGS"
        
        # Get the ci-azure-deploy tag specifically
        DEPLOY_TAG=$(echo "$FULL_TAGS" | tr ',' '\n' | grep "ci-azure-deploy-" | head -1)
        
        if [ -z "$DEPLOY_TAG" ]; then
          echo "âŒ Could not find deployment tag"
          exit 1
        fi
        
        echo "deploy_tag=$DEPLOY_TAG" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Deployment tag: $DEPLOY_TAG"

    - name: Image build summary
      run: |
        echo "ğŸ³ Docker image built and pushed successfully"
        echo "ğŸ“‹ All image tags: ${{ steps.meta.outputs.tags }}"
        echo "ğŸ¯ Deploy tag: ${{ steps.extract_tag.outputs.deploy_tag }}"
        echo "ğŸ”— Image digest: ${{ steps.build.outputs.digest }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/ci/azure-deploy'
    
    environment:
      name: 'Production'
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    steps:
    - name: Verify deployment image
      run: |
        echo "ğŸ” Verifying deployment configuration..."
        echo "Image to deploy: ${{ needs.build-and-push.outputs.image_tag }}"
        echo "Commit SHA: ${{ github.sha }}"
        echo "App Service: ${{ env.AZURE_WEBAPP_NAME }}"

    - name: Configure Azure App Service for Container
      run: |
        echo "ğŸ”§ Configuring App Service for container deployment..."
        
        # Install Azure CLI
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        
        echo "ğŸ“¦ Updating container configuration via REST API..."
        echo "ğŸ¯ Using image: ${{ needs.build-and-push.outputs.image_tag }}"
        
        CONTAINER_CONFIG=$(cat << EOF
        {
          "DOCKER_CUSTOM_IMAGE_NAME": "${{ needs.build-and-push.outputs.image_tag }}",
          "DOCKER_REGISTRY_SERVER_URL": "https://${{ env.ACR_REGISTRY }}",
          "DOCKER_REGISTRY_SERVER_USERNAME": "${{ secrets.ACR_USERNAME }}",
          "DOCKER_REGISTRY_SERVER_PASSWORD": "${{ secrets.ACR_PASSWORD }}",
          "WEBSITES_PORT": "8082",
          "WEBSITES_ENABLE_APP_SERVICE_STORAGE": "false",
          "SPRING_PROFILES_ACTIVE": "production",
          "SPRING_CONFIG_IMPORT": "optional:classpath:application-secrets.properties"
        }
        EOF
        )
        
        echo "ğŸ”„ Applying container configuration..."
        
        # Update container settings
        curl -X POST \
          -H "Content-Type: application/json" \
          -u '${{ secrets.ACR_USERNAME }}:${{ secrets.ACR_PASSWORD }}' \
          -d "$CONTAINER_CONFIG" \
          "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/settings"
        
        # Force container restart to pull new image
        curl -X POST \
          -H "Content-Type: application/json" \
          -u '${{ secrets.ACR_USERNAME }}:${{ secrets.ACR_PASSWORD }}' \
          "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/container/restart"
        
        echo "âœ… Container configuration and restart triggered"

    - name: Wait for container deployment with enhanced monitoring
      run: |
        echo "â³ Waiting for container deployment to complete..."
        echo "ğŸ¯ Monitoring for image: ${{ needs.build-and-push.outputs.image_tag }}"
        
        # Initial wait for container pull
        echo "ğŸ• Initial wait for container pull (60 seconds)..."
        sleep 60
        
        for i in {1..20}; do  # 20 attempts = 15 minutes
          echo "ğŸ” Monitoring attempt $i/20 ($(($i * 45)) seconds elapsed)..."
          
          # Get container logs
          LOGS=$(curl -s -u '${{ secrets.ACR_USERNAME }}:${{ secrets.ACR_PASSWORD }}' \
            "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/logs/docker" 2>/dev/null || echo "")
          
          # Check for successful Spring Boot startup
          if echo "$LOGS" | grep -q "Started.*Application\|Tomcat started on port\|Application startup"; then
            echo "âœ… Spring Boot application started successfully!"
            echo "ğŸ“‹ Recent startup confirmation:"
            echo "$LOGS" | grep -E "Started.*Application|Tomcat started|Application startup" | tail -2
            break
          elif echo "$LOGS" | grep -q "Error\|Exception\|Failed.*start"; then
            echo "âŒ Error detected in container startup:"
            echo "$LOGS" | grep -E "Error|Exception|Failed.*start" | tail -3
            echo ""
            echo "ğŸ“‹ Full recent logs for diagnosis:"
            echo "$LOGS" | tail -10
          elif echo "$LOGS" | grep -q "Pulling\|Downloaded\|Starting"; then
            echo "â³ Container pulling/starting... Latest activity:"
            echo "$LOGS" | grep -E "Pulling|Downloaded|Starting" | tail -2
          else
            echo "â³ Waiting for container activity..."
          fi
          
          # Check if we've reached the end without success
          if [ $i -eq 20 ]; then
            echo "âŒ Container startup monitoring timeout"
            echo "ğŸ“‹ Final logs for diagnosis:"
            echo "$LOGS" | tail -15
            exit 1
          fi
          
          sleep 45
        done
        
        echo "âœ… Container monitoring completed successfully"

    - name: Enhanced health check with Spring Boot focus
      run: |
        echo "ğŸ¥ Starting Spring Boot application health check..."
        
        # Spring Boot specific endpoints to test
        ENDPOINTS=(
          "/actuator/health"
          "/actuator"
          "/"
        )
        
        SUCCESS=false
        BASE_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        
        for attempt in {1..12}; do
          echo "ğŸ” Health check attempt $attempt/12..."
          
          for endpoint in "${ENDPOINTS[@]}"; do
            URL="$BASE_URL$endpoint"
            echo "   Testing: $endpoint"
            
            RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" --max-time 30 "$URL" 2>/dev/null || echo "HTTPSTATUS:000")
            HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            RESPONSE_BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
            
            echo "   Status: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… SUCCESS! Application is healthy and responding"
              echo "ğŸŒ Backend URL: $BASE_URL"
              echo "ğŸ³ Container image: ${{ needs.build-and-push.outputs.image_tag }}"
              echo "ğŸ“Š Response preview: ${RESPONSE_BODY:0:150}..."
              
              # Special check for health endpoint
              if [ "$endpoint" = "/actuator/health" ]; then
                echo "ğŸ’š Health endpoint details:"
                echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
              fi
              
              SUCCESS=true
              break 2
            elif [ "$HTTP_STATUS" = "404" ]; then
              echo "   404 - Endpoint not found"
            elif [ "$HTTP_STATUS" = "500" ] || [ "$HTTP_STATUS" = "503" ]; then
              echo "   Server error - application may still be initializing"
            else
              echo "   Connection failed or unexpected status"
            fi
          done
          
          if [ "$SUCCESS" = true ]; then
            break
          fi
          
          echo "â³ All endpoints failed, waiting 25 seconds before retry..."
          sleep 25
        done
        
        if [ "$SUCCESS" = false ]; then
          echo "âŒ All health check attempts failed"
          echo "ğŸ” Final diagnostic information:"
          
          echo "ğŸ“‹ Recent container logs:"
          curl -s -u '${{ secrets.ACR_USERNAME }}:${{ secrets.ACR_PASSWORD }}' \
            "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/logs/docker" 2>/dev/null | tail -20
          
          echo ""
          echo "ğŸ“‹ Container settings:"
          curl -s -u '${{ secrets.ACR_USERNAME }}:${{ secrets.ACR_PASSWORD }}' \
            "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/settings" 2>/dev/null | head -10
          
          exit 1
        fi

    - name: Deployment summary
      if: success()
      run: |
        echo "ğŸ‰ Container deployment completed successfully!"
        echo "=================================================="
        echo "ğŸ“‹ Deployment Summary:"
        echo "   â€¢ App Service: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "   â€¢ Container Registry: ${{ env.ACR_REGISTRY }}"
        echo "   â€¢ Image: ${{ needs.build-and-push.outputs.image_tag }}"
        echo "   â€¢ Commit SHA: ${{ github.sha }}"
        echo "   â€¢ Port: 8082"
        echo "   â€¢ Profile: production"
        echo "   â€¢ Health Check: âœ… Passed"
        echo "   â€¢ URL: ${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "   â€¢ Authentication: ACR Credentials"
        echo "=================================================="

    - name: Post-deployment validation
      if: success()
      run: |
        echo "ğŸ” Running final deployment validation..."
        
        BASE_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        
        echo "Testing key endpoints:"
        
        # Test root endpoint
        if curl -s -f "$BASE_URL/" > /dev/null; then
          echo "âœ… Root endpoint (/) responding"
        else
          echo "âš ï¸ Root endpoint (/) not responding"
        fi
        
        # Test health endpoint with detailed output
        if curl -s -f "$BASE_URL/actuator/health" > /dev/null; then
          echo "âœ… Health endpoint (/actuator/health) responding"
          echo "ğŸ“Š Health status details:"
          HEALTH_RESPONSE=$(curl -s "$BASE_URL/actuator/health")
          echo "$HEALTH_RESPONSE" | jq '.' 2>/dev/null || echo "$HEALTH_RESPONSE"
        else
          echo "âš ï¸ Health endpoint (/actuator/health) not responding"
        fi
        
        # Verify the correct image is deployed
        echo ""
        echo "ğŸ” Verifying deployed image version..."
        echo "Expected: ${{ needs.build-and-push.outputs.image_tag }}"
        echo "Commit SHA: ${{ github.sha }}"
        
        echo "ğŸ Deployment validation completed successfully!"

